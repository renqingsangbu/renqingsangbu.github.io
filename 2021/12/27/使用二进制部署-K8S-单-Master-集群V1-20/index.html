<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>使用二进制部署 K8S 单 Master 集群V1.20 | RenChing</title><meta name="description" content="使用二进制部署 K8S 单 Master 集群V1.20"><meta name="keywords" content="Kubernetes,K8S"><meta name="author" content="RenChing Doe"><meta name="copyright" content="RenChing Doe"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://yoursite.com/2021/12/27/使用二进制部署-K8S-单-Master-集群V1-20/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="使用二进制部署 K8S 单 Master 集群V1.20"><meta name="twitter:description" content="使用二进制部署 K8S 单 Master 集群V1.20"><meta name="twitter:image" content="https://img-blog.csdnimg.cn/5494d8aa7bfa4b0d91b4b9a3f6388710.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUmVuQ2hpbmc=,size_20,color_FFFFFF,t_70,g_se,x_16"><meta property="og:type" content="article"><meta property="og:title" content="使用二进制部署 K8S 单 Master 集群V1.20"><meta property="og:url" content="http://yoursite.com/2021/12/27/使用二进制部署-K8S-单-Master-集群V1-20/"><meta property="og:site_name" content="RenChing"><meta property="og:description" content="使用二进制部署 K8S 单 Master 集群V1.20"><meta property="og:image" content="https://img-blog.csdnimg.cn/5494d8aa7bfa4b0d91b4b9a3f6388710.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUmVuQ2hpbmc=,size_20,color_FFFFFF,t_70,g_se,x_16"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="基于 Docker-compose 部署 Jumpserver 堡垒机" href="http://yoursite.com/2021/12/27/基于-Docker-compose-部署-Jumpserver-堡垒机/"><link rel="next" title="使用 Kubeadm 部署 K8S 集群V1.19.0" href="http://yoursite.com/2021/12/27/使用-Kubeadm-部署-K8S-集群V1-19-0/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://renqingsangbu.github.io","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Bookmark',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days'

  
}</script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#使用二进制部署-K8S-单-Master-集群V1-20"><span class="toc-text">使用二进制部署 K8S 单 Master 集群V1.20</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、前置知识点"><span class="toc-text">一、前置知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-生产环境部署-K8s-集群的两种方式"><span class="toc-text">1.1 生产环境部署 K8s 集群的两种方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-准备环境"><span class="toc-text">1.2 准备环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-操作系统初始化配置"><span class="toc-text">1.3 操作系统初始化配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、部署Etcd集群"><span class="toc-text">二、部署Etcd集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-准备cfssl证书生成工具"><span class="toc-text">2.1 准备cfssl证书生成工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-生成Etcd证书"><span class="toc-text">2.2 生成Etcd证书</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-自签证书颁发机构（CA）"><span class="toc-text">1. 自签证书颁发机构（CA）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-使用自签CA签发Etcd-HTTPS证书"><span class="toc-text">2. 使用自签CA签发Etcd HTTPS证书</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-从Github下载二进制文件"><span class="toc-text">2.3 从Github下载二进制文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-部署Etcd集群"><span class="toc-text">2.4 部署Etcd集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-创建工作目录并解压二进制包"><span class="toc-text">1. 创建工作目录并解压二进制包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-创建etcd配置文件"><span class="toc-text">2. 创建etcd配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-systemd管理etcd"><span class="toc-text">3. systemd管理etcd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-拷贝刚才生成的证书"><span class="toc-text">4. 拷贝刚才生成的证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-启动并设置开机启动"><span class="toc-text">5. 启动并设置开机启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-将上面Master-节点所有生成的文件拷贝到两台-Node-节点"><span class="toc-text">6. 将上面Master 节点所有生成的文件拷贝到两台 Node 节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-查看集群状态"><span class="toc-text">7. 查看集群状态</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、安装Docker"><span class="toc-text">三、安装Docker</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-解压二进制包"><span class="toc-text">3.1 解压二进制包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-systemd管理docker"><span class="toc-text">3.2 systemd管理docker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-启动并设置开机启动"><span class="toc-text">3.3 启动并设置开机启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-设置镜像加速器"><span class="toc-text">3.4 设置镜像加速器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、部署-Master-Node"><span class="toc-text">四、部署 Master Node</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-生成kube-apiserver证书"><span class="toc-text">4.1 生成kube-apiserver证书</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-自签证书颁发机构（CA）-1"><span class="toc-text">1. 自签证书颁发机构（CA）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-使用自签CA签发kube-apiserver-HTTPS证书"><span class="toc-text">2. 使用自签CA签发kube-apiserver HTTPS证书</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-从Github下载二进制文件"><span class="toc-text">4.2 从Github下载二进制文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-解压二进制包"><span class="toc-text">4.3 解压二进制包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-部署kube-apiserver"><span class="toc-text">4.4 部署kube-apiserver</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-创建配置文件"><span class="toc-text">1. 创建配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-拷贝刚才生成的证书"><span class="toc-text">2. 拷贝刚才生成的证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-启用-TLS-Bootstrapping-机制"><span class="toc-text">3. 启用 TLS Bootstrapping 机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-systemd管理apiserver"><span class="toc-text">4. systemd管理apiserver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-启动并设置开机启动-1"><span class="toc-text">5. 启动并设置开机启动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-部署kube-controller-manager"><span class="toc-text">4.5 部署kube-controller-manager</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-创建配置文件-1"><span class="toc-text">1. 创建配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-生成kubeconfig文件"><span class="toc-text">2. 生成kubeconfig文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-systemd管理controller-manager"><span class="toc-text">3. systemd管理controller-manager</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-启动并设置开机启动"><span class="toc-text">4. 启动并设置开机启动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-部署kube-scheduler"><span class="toc-text">4.6 部署kube-scheduler</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-创建配置文件-2"><span class="toc-text">1. 创建配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-生成kubeconfig文件-1"><span class="toc-text">2. 生成kubeconfig文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-systemd管理scheduler"><span class="toc-text">3. systemd管理scheduler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-启动并设置开机启动-1"><span class="toc-text">4. 启动并设置开机启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-查看集群状态"><span class="toc-text">5. 查看集群状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-授权kubelet-bootstrap用户允许请求证书"><span class="toc-text">6. 授权kubelet-bootstrap用户允许请求证书</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、部署Worker-Node"><span class="toc-text">五、部署Worker Node</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-创建工作目录并拷贝二进制文件"><span class="toc-text">5.1 创建工作目录并拷贝二进制文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-部署kubelet"><span class="toc-text">5.2 部署kubelet</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-创建配置文件-3"><span class="toc-text">1. 创建配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-配置参数文件"><span class="toc-text">2. 配置参数文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-生成kubelet初次加入集群引导kubeconfig文件"><span class="toc-text">3. 生成kubelet初次加入集群引导kubeconfig文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-systemd管理kubelet"><span class="toc-text">4. systemd管理kubelet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-启动并设置开机启动-2"><span class="toc-text">5. 启动并设置开机启动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-批准kubelet证书申请并加入集群"><span class="toc-text">5.3 批准kubelet证书申请并加入集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-部署kube-proxy"><span class="toc-text">5.4 部署kube-proxy</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-创建配置文件-4"><span class="toc-text">1. 创建配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-配置参数文件-1"><span class="toc-text">2. 配置参数文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-生成kube-proxy-kubeconfig文件"><span class="toc-text">3. 生成kube-proxy.kubeconfig文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-systemd管理kube-proxy"><span class="toc-text">4. systemd管理kube-proxy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-启动并设置开机启动-3"><span class="toc-text">5. 启动并设置开机启动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-部署网络组件"><span class="toc-text">5.5 部署网络组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-授权apiserver访问kubelet"><span class="toc-text">5.6 授权apiserver访问kubelet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-新增加Worker-Node"><span class="toc-text">5.7 新增加Worker Node</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-拷贝已部署好的-Node节点相关文件到两台-Node-节点"><span class="toc-text">1. 拷贝已部署好的 Node节点相关文件到两台 Node 节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-删除kubelet证书和kubeconfig文件"><span class="toc-text">2. 删除kubelet证书和kubeconfig文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-修改主机名（192-168-71-102-103两台都要改）k8s-node1、k8s-node2"><span class="toc-text">3. 修改主机名（192.168.71.102/103两台都要改）k8s-node1、k8s-node2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-启动并设置开机启动-2"><span class="toc-text">4. 启动并设置开机启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-在Master上批准新Node-kubelet证书申请"><span class="toc-text">5. 在Master上批准新Node kubelet证书申请</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-查看Node状态"><span class="toc-text">6. 查看Node状态</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、部署Dashboard和CoreDNS"><span class="toc-text">六、部署Dashboard和CoreDNS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-部署Dashboard"><span class="toc-text">1. 部署Dashboard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-部署CoreDNS"><span class="toc-text">2. 部署CoreDNS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#一、准备yaml配置文件"><span class="toc-text">一、准备yaml配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#二、通过yaml配置文件创建coredns"><span class="toc-text">二、通过yaml配置文件创建coredns</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七、部署Ingress-nginx-0-30"><span class="toc-text">七、部署Ingress nginx 0.30</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Ingress概述"><span class="toc-text">1. Ingress概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Ingress-是什么"><span class="toc-text">2. Ingress 是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-部署Ingress-Nginx"><span class="toc-text">3. 部署Ingress-Nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-deploy-service的yaml信息"><span class="toc-text">4. deploy_service的yaml信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Ingress-HTTP代理访问"><span class="toc-text">5. Ingress HTTP代理访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-浏览器访问"><span class="toc-text">6. 浏览器访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-Ingress-HTTPS代理访问"><span class="toc-text">6. Ingress HTTPS代理访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-启动ingress-https并查看状态"><span class="toc-text">7. 启动ingress https并查看状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-浏览器访问"><span class="toc-text">8. 浏览器访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#八-安装-Metrics-Server"><span class="toc-text">八. 安装 Metrics- Server</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-部署-Metrics-Server"><span class="toc-text">1 部署 Metrics Server</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#下载-YAML-文件"><span class="toc-text">下载 YAML 文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#修改-Metrics-Server-的启动参数"><span class="toc-text">修改 Metrics Server 的启动参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#部署-Metrics-Server"><span class="toc-text">部署 Metrics Server</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#检查-Metrics-Server-Pod状态"><span class="toc-text">检查 Metrics Server Pod状态</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#手动下载-Metrics-Server-镜像"><span class="toc-text">手动下载 Metrics Server 镜像</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#部署-Metrics-Server-1"><span class="toc-text">部署 Metrics Server</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#检查-Metrics-Server-Pod状态-1"><span class="toc-text">检查 Metrics Server Pod状态</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#检查-Metrics-Server-Service"><span class="toc-text">检查 Metrics Server Service</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-检查-Metrics-Server-是否可用"><span class="toc-text">3 检查 Metrics Server 是否可用</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://img-blog.csdnimg.cn/5494d8aa7bfa4b0d91b4b9a3f6388710.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUmVuQ2hpbmc=,size_20,color_FFFFFF,t_70,g_se,x_16)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">RenChing</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><span class="pull-right menus"><div class="mobile_author_icon"><img class="lozad" data-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"><div class="mobile_author-info__description"></div></div><hr><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标籤</span></a><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title"><div class="posttitle">使用二进制部署 K8S 单 Master 集群V1.20</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2021-12-27<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> Updated 2021-12-27</time></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="使用二进制部署-K8S-单-Master-集群V1-20"><a href="#使用二进制部署-K8S-单-Master-集群V1-20" class="headerlink" title="使用二进制部署 K8S 单 Master 集群V1.20"></a>使用二进制部署 K8S 单 Master 集群V1.20</h1><h2 id="一、前置知识点"><a href="#一、前置知识点" class="headerlink" title="一、前置知识点"></a>一、前置知识点</h2><h3 id="1-1-生产环境部署-K8s-集群的两种方式"><a href="#1-1-生产环境部署-K8s-集群的两种方式" class="headerlink" title="1.1 生产环境部署 K8s 集群的两种方式"></a>1.1 生产环境部署 K8s 集群的两种方式</h3><p>•   <strong>kubeadm</strong></p>
<p>Kubeadm是一个K8s部署工具，提供kubeadm init和kubeadm join，用于快速部署Kubernetes集群。</p>
<p>•   <strong>二进制包</strong></p>
<p>从github下载发行版的二进制包，手动部署每个组件，组成Kubernetes集群。</p>
<p>小结：Kubeadm降低部署门槛，但屏蔽了很多细节，遇到问题很难排查。如果想更容易可控，推荐使用二进制包部署Kubernetes集群，虽然手动部署麻烦点，期间可以学习很多工作原理，也利于后期维护。 </p>
<h3 id="1-2-准备环境"><a href="#1-2-准备环境" class="headerlink" title="1.2 准备环境"></a>1.2 准备环境</h3><blockquote>
<p><strong>服务器要求：</strong></p>
</blockquote>
<p>•   建议最小硬件配置：2核CPU、2G内存、30G硬盘</p>
<p>•   服务器最好可以访问外网，会有从网上拉取镜像需求，如果服务器不能上网，需要提前下载对应镜像并导入节点</p>
<blockquote>
<p><strong>软件环境：</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th><strong>软件</strong></th>
<th><strong>版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>操作系统</td>
<td>CentOS7.x_x64 （mini）</td>
</tr>
<tr>
<td>容器引擎</td>
<td>Docker CE 19</td>
</tr>
<tr>
<td>Kubernetes</td>
<td>Kubernetes v1.20</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>服务器整体规划：</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th><strong>角色</strong></th>
<th><strong>IP</strong></th>
<th><strong>组件</strong></th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master1</td>
<td>192.168.71.101</td>
<td>kube-apiserver，kube-controller-manager，kube-scheduler，kubelet，kube-proxy，docker，etcd</td>
</tr>
<tr>
<td>k8s-node1</td>
<td>192.168.71.102</td>
<td>kubelet，kube-proxy，docker，etcd</td>
</tr>
<tr>
<td>k8s-node2</td>
<td>192.168.71.103</td>
<td>kubelet，kube-proxy，docker，etcd</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>单Master架构图：</strong></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/20210510175607322.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODc3OTI1OA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<blockquote>
<p><strong>单Master服务器规划：</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th><strong>角色</strong></th>
<th><strong>IP</strong></th>
<th><strong>组件</strong></th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master1</td>
<td>192.168.71.101</td>
<td>kube-apiserver，kube-controller-manager，kube-scheduler，etcd</td>
</tr>
<tr>
<td>k8s-node1</td>
<td>192.168.71.102</td>
<td>kubelet，kube-proxy，docker，etcd</td>
</tr>
<tr>
<td>k8s-node2</td>
<td>192.168.71.103</td>
<td>kubelet，kube-proxy，docker，etcd</td>
</tr>
</tbody></table>
<h3 id="1-3-操作系统初始化配置"><a href="#1-3-操作系统初始化配置" class="headerlink" title="1.3 操作系统初始化配置"></a>1.3 操作系统初始化配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 关闭防火墙 </span><br><span class="line">systemctl stop firewalld </span><br><span class="line">systemctl disable firewalld </span><br><span class="line"> </span><br><span class="line"># 关闭selinux </span><br><span class="line">sed -i &apos;s/enforcing/disabled/&apos; /etc/selinux/config  # 永久 </span><br><span class="line">setenforce 0  # 临时 </span><br><span class="line"># 关闭swap </span><br><span class="line">swapoff -a  # 临时 </span><br><span class="line">sed -ri &apos;s/.*swap.*/#&amp;/&apos; /etc/fstab    # 永久 </span><br><span class="line"> </span><br><span class="line"># 根据规划设置主机名 </span><br><span class="line">hostnamectl set-hostname &lt;hostname&gt; </span><br><span class="line"> </span><br><span class="line"># 在master添加hosts </span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.71.101 k8s-master1</span><br><span class="line">192.168.71.102 k8s-node1</span><br><span class="line">192.168.71.103 k8s-node2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 将桥接的IPv4流量传递到iptables的链 </span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF </span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1 </span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1 </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 生效 </span><br><span class="line">sysctl --system</span><br><span class="line"> </span><br><span class="line"># 时间同步 </span><br><span class="line">yum install ntpdate -y </span><br><span class="line">ntpdate time.windows.com</span><br></pre></td></tr></table></figure>

<h2 id="二、部署Etcd集群"><a href="#二、部署Etcd集群" class="headerlink" title="二、部署Etcd集群"></a>二、部署Etcd集群</h2><p>Etcd 是一个分布式键值存储系统，Kubernetes使用Etcd进行数据存储，所以先准备一个Etcd数据库，为解决Etcd单点故障，应采用集群方式部署，这里使用3台组建集群，可容忍1台机器故障，当然，也可以使用5台组建集群，可容忍2台机器故障。</p>
<table>
<thead>
<tr>
<th><strong>节点名称</strong></th>
<th><strong>IP</strong></th>
</tr>
</thead>
<tbody><tr>
<td>etcd-1</td>
<td>192.168.71.101</td>
</tr>
<tr>
<td>etcd-2</td>
<td>192.168.71.102</td>
</tr>
<tr>
<td>etcd-3</td>
<td>192.168.71.103</td>
</tr>
</tbody></table>
<p><strong>注：为了节省机器，这里与K8s Master节点机器复用。Etcd也可以独立于k8s集群之外部署，只要apiserver能连接到就行。</strong></p>
<h3 id="2-1-准备cfssl证书生成工具"><a href="#2-1-准备cfssl证书生成工具" class="headerlink" title="2.1 准备cfssl证书生成工具"></a>2.1 准备cfssl证书生成工具</h3><p><strong>cfssl是一个开源的证书管理工具，使用json文件生成证书，相比openssl更方便使用</strong></p>
<blockquote>
<p>找任意一台服务器操作，这里用Master节点</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line">chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span><br><span class="line">mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line">mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line">mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</span><br></pre></td></tr></table></figure>

<h3 id="2-2-生成Etcd证书"><a href="#2-2-生成Etcd证书" class="headerlink" title="2.2 生成Etcd证书"></a>2.2 生成Etcd证书</h3><h4 id="1-自签证书颁发机构（CA）"><a href="#1-自签证书颁发机构（CA）" class="headerlink" title="1. 自签证书颁发机构（CA）"></a>1. 自签证书颁发机构（CA）</h4><blockquote>
<p><strong>创建工作目录：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/TLS/&#123;etcd,k8s&#125;</span><br><span class="line"></span><br><span class="line">cd ~/TLS/etcd</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>自签CA：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;www&quot;: &#123;</span><br><span class="line">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">         &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd CA&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>生成证书：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br></pre></td></tr></table></figure>

<p>会生成ca.pem和ca-key.pem文件。</p>
<h4 id="2-使用自签CA签发Etcd-HTTPS证书"><a href="#2-使用自签CA签发Etcd-HTTPS证书" class="headerlink" title="2. 使用自签CA签发Etcd HTTPS证书"></a>2. 使用自签CA签发Etcd HTTPS证书</h4><blockquote>
<p><strong>创建证书申请文件：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; server-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    &quot;192.168.71.101&quot;,</span><br><span class="line">    &quot;192.168.71.102&quot;,</span><br><span class="line">    &quot;192.168.71.103&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;BeiJing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>注：上述文件hosts字段中IP为所有etcd节点的集群内部通信IP，一个都不能少！为了方便后期扩容可以多写几个预留的IP。</strong></p>
<blockquote>
<p><strong>生成证书：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server</span><br></pre></td></tr></table></figure>

<p>会生成server.pem和server-key.pem文件</p>
<h3 id="2-3-从Github下载二进制文件"><a href="#2-3-从Github下载二进制文件" class="headerlink" title="2.3 从Github下载二进制文件"></a>2.3 从Github下载二进制文件</h3><p>下载地址：<a href="https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz" target="_blank" rel="noopener">https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz</a></p>
<h3 id="2-4-部署Etcd集群"><a href="#2-4-部署Etcd集群" class="headerlink" title="2.4 部署Etcd集群"></a>2.4 部署Etcd集群</h3><blockquote>
<p>以下在 Master 节点上操作，为简化操作，待会儿将 Master 节点生成的所有文件拷贝到节点两台 Node 节点</p>
</blockquote>
<h4 id="1-创建工作目录并解压二进制包"><a href="#1-创建工作目录并解压二进制包" class="headerlink" title="1. 创建工作目录并解压二进制包"></a>1. 创建工作目录并解压二进制包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /opt/etcd/&#123;bin,cfg,ssl&#125; -p</span><br><span class="line">tar zxvf etcd-v3.4.9-linux-amd64.tar.gz</span><br><span class="line">mv etcd-v3.4.9-linux-amd64/&#123;etcd,etcdctl&#125; /opt/etcd/bin/</span><br></pre></td></tr></table></figure>

<h4 id="2-创建etcd配置文件"><a href="#2-创建etcd配置文件" class="headerlink" title="2. 创建etcd配置文件"></a>2. 创建etcd配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; EOF</span><br><span class="line">#[Member]</span><br><span class="line">ETCD_NAME=&quot;etcd-1&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.71.101:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.71.101:2379&quot;</span><br><span class="line"> </span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.71.101:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.71.101:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.71.101:2380,etcd-2=https://192.168.71.102:2380,etcd-3=https://192.168.71.103:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>•   ETCD_NAME：节点名称，集群中唯一<br>•   ETCD_DATA_DIR：数据目录<br>•   ETCD_LISTEN_PEER_URLS：集群通信监听地址<br>•   ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址<br>•   ETCD_INITIAL_ADVERTISE_PEERURLS：集群通告地址<br>•   ETCD_ADVERTISE_CLIENT_URLS：客户端通告地址<br>•   ETCD_INITIAL_CLUSTER：集群节点地址<br>•   ETCD_INITIALCLUSTER_TOKEN：集群Token<br>•   ETCD_INITIALCLUSTER_STATE：加入集群的当前状态，new是新集群，existing表示加入已有集群</p>
</blockquote>
<h4 id="3-systemd管理etcd"><a href="#3-systemd管理etcd" class="headerlink" title="3. systemd管理etcd"></a>3. systemd管理etcd</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/opt/etcd/cfg/etcd.conf</span><br><span class="line">ExecStart=/opt/etcd/bin/etcd \</span><br><span class="line">--cert-file=/opt/etcd/ssl/server.pem \</span><br><span class="line">--key-file=/opt/etcd/ssl/server-key.pem \</span><br><span class="line">--peer-cert-file=/opt/etcd/ssl/server.pem \</span><br><span class="line">--peer-key-file=/opt/etcd/ssl/server-key.pem \</span><br><span class="line">--trusted-ca-file=/opt/etcd/ssl/ca.pem \</span><br><span class="line">--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \</span><br><span class="line">--logger=zap</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="4-拷贝刚才生成的证书"><a href="#4-拷贝刚才生成的证书" class="headerlink" title="4. 拷贝刚才生成的证书"></a>4. 拷贝刚才生成的证书</h4><blockquote>
<p><strong>把生成的证书拷贝到配置文件中的路径：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ~/TLS/etcd/ca*pem ~/TLS/etcd/server*pem /opt/etcd/ssl/</span><br></pre></td></tr></table></figure>

<h4 id="5-启动并设置开机启动"><a href="#5-启动并设置开机启动" class="headerlink" title="5. 启动并设置开机启动"></a>5. 启动并设置开机启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl enable etcd</span><br></pre></td></tr></table></figure>

<h4 id="6-将上面Master-节点所有生成的文件拷贝到两台-Node-节点"><a href="#6-将上面Master-节点所有生成的文件拷贝到两台-Node-节点" class="headerlink" title="6. 将上面Master 节点所有生成的文件拷贝到两台 Node 节点"></a>6. 将上面Master 节点所有生成的文件拷贝到两台 Node 节点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">scp -r /opt/etcd/ root@192.168.71.102:/opt/</span><br><span class="line">scp /usr/lib/systemd/system/etcd.service root@192.168.71.102:/usr/lib/systemd/system</span><br><span class="line"></span><br><span class="line">scp -r /opt/etcd/ root@192.168.71.103:/opt/</span><br><span class="line">scp /usr/lib/systemd/system/etcd.service root@192.168.71.103:/usr/lib/systemd/system</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>然后在两台 Node 节点分别修改 etcd.conf 配置文件中的节点名称和当前服务器IP：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vi /opt/etcd/cfg/etcd.conf</span><br><span class="line">#[Member]</span><br><span class="line">ETCD_NAME=&quot;etcd-1&quot;   # 修改此处，节点2改为etcd-2，节点3改为etcd-3</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.71.101:2380&quot;   # 修改此处为当前服务器IP</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.71.101:2379&quot; # 修改此处为当前服务器IP</span><br><span class="line"></span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.71.101:2380&quot; # 修改此处为当前服务器IP</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.71.101:2379&quot; # 修改此处为当前服务器IP</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.71.101:2380,etcd-2=https://192.168.71.102:2380,etcd-3=https://192.168.71.103:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br></pre></td></tr></table></figure>

<p><strong>最后启动etcd并设置开机启动，同上。</strong></p>
<h4 id="7-查看集群状态"><a href="#7-查看集群状态" class="headerlink" title="7. 查看集群状态"></a>7. 查看集群状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ~/check_etcd_culster.sh &lt;&lt; EOF</span><br><span class="line">ETCDCTL_API=3 /opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.71.101:2379,https://192.168.71.102:2379,https://192.168.71.103:2379&quot; endpoint health --write-out=table</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 执行脚本</span><br><span class="line">bash ~/check_etcd_culster.sh </span><br><span class="line">+-----------------------------+--------+-------------+-------+</span><br><span class="line">|          ENDPOINT           | HEALTH |    TOOK     | ERROR |</span><br><span class="line">+-----------------------------+--------+-------------+-------+</span><br><span class="line">| https://192.168.71.101:2379 |   true |  7.532141ms |       |</span><br><span class="line">| https://192.168.71.102:2379 |   true |  9.423927ms |       |</span><br><span class="line">| https://192.168.71.103:2379 |   true | 10.080726ms |       |</span><br><span class="line">+-----------------------------+--------+-------------+-------+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果输出上面信息，就说明集群部署成功。<br>如果有问题第一步先看日志：/var/log/message 或 journalctl -u etcd</p>
</blockquote>
<h2 id="三、安装Docker"><a href="#三、安装Docker" class="headerlink" title="三、安装Docker"></a>三、安装Docker</h2><p>这里使用Docker作为容器引擎，也可以换成别的，例如containerd</p>
<p>下载地址：<a href="https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz" target="_blank" rel="noopener">https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz</a></p>
<blockquote>
<p><strong>以下在所有节点操作</strong></p>
<p>这里采用二进制安装，用yum安装也一样。</p>
</blockquote>
<h3 id="3-1-解压二进制包"><a href="#3-1-解压二进制包" class="headerlink" title="3.1 解压二进制包"></a>3.1 解压二进制包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf docker-19.03.9.tgz</span><br><span class="line">mv docker/* /usr/bin</span><br></pre></td></tr></table></figure>

<h3 id="3-2-systemd管理docker"><a href="#3-2-systemd管理docker" class="headerlink" title="3.2 systemd管理docker"></a>3.2 systemd管理docker</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="3-3-启动并设置开机启动"><a href="#3-3-启动并设置开机启动" class="headerlink" title="3.3 启动并设置开机启动"></a>3.3 启动并设置开机启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure>

<h3 id="3-4-设置镜像加速器"><a href="#3-4-设置镜像加速器" class="headerlink" title="3.4 设置镜像加速器"></a>3.4 设置镜像加速器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://uu9mw5dx.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<h2 id="四、部署-Master-Node"><a href="#四、部署-Master-Node" class="headerlink" title="四、部署 Master Node"></a>四、部署 Master Node</h2><h3 id="4-1-生成kube-apiserver证书"><a href="#4-1-生成kube-apiserver证书" class="headerlink" title="4.1 生成kube-apiserver证书"></a>4.1 生成kube-apiserver证书</h3><h4 id="1-自签证书颁发机构（CA）-1"><a href="#1-自签证书颁发机构（CA）-1" class="headerlink" title="1. 自签证书颁发机构（CA）"></a>1. 自签证书颁发机构（CA）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">cd ~/TLS/k8s</span><br><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">         &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>生成证书：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br></pre></td></tr></table></figure>

<p><strong>会生成ca.pem和ca-key.pem文件。</strong></p>
<h4 id="2-使用自签CA签发kube-apiserver-HTTPS证书"><a href="#2-使用自签CA签发kube-apiserver-HTTPS证书" class="headerlink" title="2. 使用自签CA签发kube-apiserver HTTPS证书"></a>2. 使用自签CA签发kube-apiserver HTTPS证书</h4><blockquote>
<p><strong>创建证书申请文件：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; server-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">      &quot;10.0.0.1&quot;,</span><br><span class="line">      &quot;127.0.0.1&quot;,</span><br><span class="line">      &quot;192.168.71.101&quot;,</span><br><span class="line">      &quot;192.168.71.102&quot;,</span><br><span class="line">      &quot;192.168.71.103&quot;,</span><br><span class="line">      &quot;192.168.71.104&quot;,</span><br><span class="line">      &quot;kubernetes&quot;,</span><br><span class="line">      &quot;kubernetes.default&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>注：上述文件hosts字段中IP为所有Master/LB/VIP IP，一个都不能少！为了方便后期扩容可以多写几个预留的IP。</strong></p>
<blockquote>
<p><strong>生成证书：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span><br></pre></td></tr></table></figure>

<p><strong>会生成server.pem和server-key.pem文件。</strong></p>
<h3 id="4-2-从Github下载二进制文件"><a href="#4-2-从Github下载二进制文件" class="headerlink" title="4.2 从Github下载二进制文件"></a>4.2 从Github下载二进制文件</h3><p>下载地址： <a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md</a></p>
<p><strong>注：打开链接里面有很多包，下载一个server包就够了，包含了Master和Worker Node二进制文件。</strong></p>
<h3 id="4-3-解压二进制包"><a href="#4-3-解压二进制包" class="headerlink" title="4.3 解压二进制包"></a>4.3 解压二进制包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125; </span><br><span class="line">tar zxvf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">cd kubernetes/server/bin</span><br><span class="line">cp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin</span><br><span class="line">cp kubectl /usr/bin/</span><br></pre></td></tr></table></figure>

<h3 id="4-4-部署kube-apiserver"><a href="#4-4-部署kube-apiserver" class="headerlink" title="4.4 部署kube-apiserver"></a>4.4 部署kube-apiserver</h3><h4 id="1-创建配置文件"><a href="#1-创建配置文件" class="headerlink" title="1. 创建配置文件"></a>1. 创建配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-apiserver.conf &lt;&lt; EOF</span><br><span class="line">KUBE_APISERVER_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--etcd-servers=https://192.168.71.101:2379,https://192.168.71.102:2379,https://192.168.71.103:2379 \\</span><br><span class="line">--bind-address=192.168.71.101 \\</span><br><span class="line">--secure-port=6443 \\</span><br><span class="line">--advertise-address=192.168.71.101 \\</span><br><span class="line">--allow-privileged=true \\</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \\</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\</span><br><span class="line">--authorization-mode=RBAC,Node \\</span><br><span class="line">--enable-bootstrap-token-auth=true \\</span><br><span class="line">--token-auth-file=/opt/kubernetes/cfg/token.csv \\</span><br><span class="line">--service-node-port-range=30000-32767 \\</span><br><span class="line">--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\</span><br><span class="line">--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="line">--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\</span><br><span class="line">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="line">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">--service-account-issuer=api \\</span><br><span class="line">--service-account-signing-key-file=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="line">--etcd-cafile=/opt/etcd/ssl/ca.pem \\</span><br><span class="line">--etcd-certfile=/opt/etcd/ssl/server.pem \\</span><br><span class="line">--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\</span><br><span class="line">--requestheader-client-ca-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--proxy-client-cert-file=/opt/kubernetes/ssl/server.pem \\</span><br><span class="line">--proxy-client-key-file=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="line">--requestheader-allowed-names=kubernetes \\</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra- \\</span><br><span class="line">--requestheader-group-headers=X-Remote-Group \\</span><br><span class="line">--requestheader-username-headers=X-Remote-User \\</span><br><span class="line">--enable-aggregator-routing=true \\</span><br><span class="line">--audit-log-maxage=30 \\</span><br><span class="line">--audit-log-maxbackup=3 \\</span><br><span class="line">--audit-log-maxsize=100 \\</span><br><span class="line">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>注：上面两个\ \ 第一个是转义符，第二个是换行符，使用转义符是为了使用EOF保留换行符。</strong></p>
<blockquote>
<p>•   –logtostderr：启用日志<br>•   —v：日志等级<br>•   –log-dir：日志目录<br>•   –etcd-servers：etcd集群地址<br>•   –bind-address：监听地址<br>•   –secure-port：https安全端口<br>•   –advertise-address：集群通告地址<br>•   –allow-privileged：启用授权<br>•   –service-cluster-ip-range：Service虚拟IP地址段<br>•   –enable-admission-plugins：准入控制模块<br>•   –authorization-mode：认证授权，启用RBAC授权和节点自管理<br>•   –enable-bootstrap-token-auth：启用TLS bootstrap机制<br>•   –token-auth-file：bootstrap token文件<br>•   –service-node-port-range：Service nodeport类型默认分配端口范围<br>•   –kubelet-client-xxx：apiserver访问kubelet客户端证书<br>•   –tls-xxx-file：apiserver https证书<br>•   1.20版本必须加的参数：–service-account-issuer，–service-account-signing-key-file<br>•   –etcd-xxxfile：连接Etcd集群证书<br>•   –audit-log-xxx：审计日志<br>•   启动聚合层相关配置：–requestheader-client-ca-file，–proxy-client-cert-file，–proxy-client-key-file，–requestheader-allowed-names，–requestheader-extra-headers-prefix，–requestheader-group-headers，–requestheader-username-headers，–enable-aggregator-routing</p>
</blockquote>
<h4 id="2-拷贝刚才生成的证书"><a href="#2-拷贝刚才生成的证书" class="headerlink" title="2. 拷贝刚才生成的证书"></a>2. 拷贝刚才生成的证书</h4><blockquote>
<p><strong>把刚才生成的证书拷贝到配置文件中的路径：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ~/TLS/k8s/ca*pem ~/TLS/k8s/server*pem /opt/kubernetes/ssl/</span><br></pre></td></tr></table></figure>

<h4 id="3-启用-TLS-Bootstrapping-机制"><a href="#3-启用-TLS-Bootstrapping-机制" class="headerlink" title="3. 启用 TLS Bootstrapping 机制"></a>3. 启用 TLS Bootstrapping 机制</h4><p>TLS Bootstraping：Master apiserver启用TLS认证后，Node节点kubelet和kube-proxy要与kube-apiserver进行通信，必须使用CA签发的有效证书才可以，当Node节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了简化流程，Kubernetes引入了TLS bootstraping机制来自动颁发客户端证书，kubelet会以一个低权限用户自动向apiserver申请证书，kubelet的证书由apiserver动态签署。所以强烈建议在Node上使用这种方式，目前主要用于kubelet，kube-proxy还是由我们统一颁发一个证书。</p>
<p>TLS bootstraping 工作流程：</p>
<p><img src="https://img-blog.csdnimg.cn/20210510180545417.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODc3OTI1OA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<blockquote>
<p><strong>创建上述配置文件中token文件：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/token.csv &lt;&lt; EOF</span><br><span class="line">f23ebd28bc62745fb1d7d8c150016a06,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>格式：token，用户名，UID，用户组</strong></p>
<blockquote>
<p><strong>token也可自行生成替换：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">head -c 16 /dev/urandom | od -An -t x | tr -d &apos; &apos;</span><br></pre></td></tr></table></figure>

<h4 id="4-systemd管理apiserver"><a href="#4-systemd管理apiserver" class="headerlink" title="4. systemd管理apiserver"></a>4. systemd管理apiserver</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="5-启动并设置开机启动-1"><a href="#5-启动并设置开机启动-1" class="headerlink" title="5. 启动并设置开机启动"></a>5. 启动并设置开机启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-apiserver </span><br><span class="line">systemctl enable kube-apiserver</span><br></pre></td></tr></table></figure>

<h3 id="4-5-部署kube-controller-manager"><a href="#4-5-部署kube-controller-manager" class="headerlink" title="4.5 部署kube-controller-manager"></a>4.5 部署kube-controller-manager</h3><h4 id="1-创建配置文件-1"><a href="#1-创建配置文件-1" class="headerlink" title="1. 创建配置文件"></a>1. 创建配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-controller-manager.conf &lt;&lt; EOF</span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--leader-elect=true \\</span><br><span class="line">--kubeconfig=/opt/kubernetes/cfg/kube-controller-manager.kubeconfig \\</span><br><span class="line">--bind-address=127.0.0.1 \\</span><br><span class="line">--allocate-node-cidrs=true \\</span><br><span class="line">--cluster-cidr=10.244.0.0/16 \\</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \\</span><br><span class="line">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\</span><br><span class="line">--root-ca-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">--cluster-signing-duration=87600h0m0s&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>•   –kubeconfig：连接apiserver配置文件<br>•   –leader-elect：当该组件启动多个时，自动选举（HA）<br>•   –cluster-signing-cert-file/–cluster-signing-key-file：自动为kubelet颁发证书的CA，与apiserver保持一致</p>
</blockquote>
<h4 id="2-生成kubeconfig文件"><a href="#2-生成kubeconfig文件" class="headerlink" title="2. 生成kubeconfig文件"></a>2. 生成kubeconfig文件</h4><blockquote>
<p><strong>生成kube-controller-manager证书：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 切换工作目录</span><br><span class="line">cd ~/TLS/k8s</span><br><span class="line"></span><br><span class="line"># 创建证书请求文件</span><br><span class="line">cat &gt; kube-controller-manager-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;, </span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:masters&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 生成证书</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span><br></pre></td></tr></table></figure>

<blockquote>
<p> <strong>生成kubeconfig文件（以下是shell命令，直接在终端执行）：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">KUBE_CONFIG=&quot;/opt/kubernetes/cfg/kube-controller-manager.kubeconfig&quot;</span><br><span class="line">KUBE_APISERVER=&quot;https://192.168.71.101:6443&quot;</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br><span class="line">  </span><br><span class="line">kubectl config set-credentials kube-controller-manager \</span><br><span class="line">  --client-certificate=./kube-controller-manager.pem \</span><br><span class="line">  --client-key=./kube-controller-manager-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br><span class="line">  </span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-controller-manager \</span><br><span class="line">  --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br><span class="line">  </span><br><span class="line">kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-systemd管理controller-manager"><a href="#3-systemd管理controller-manager" class="headerlink" title="3. systemd管理controller-manager"></a>3. systemd管理controller-manager</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="4-启动并设置开机启动"><a href="#4-启动并设置开机启动" class="headerlink" title="4. 启动并设置开机启动"></a>4. 启动并设置开机启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-controller-manager</span><br><span class="line">systemctl enable kube-controller-manager</span><br></pre></td></tr></table></figure>

<h3 id="4-6-部署kube-scheduler"><a href="#4-6-部署kube-scheduler" class="headerlink" title="4.6 部署kube-scheduler"></a>4.6 部署kube-scheduler</h3><h4 id="1-创建配置文件-2"><a href="#1-创建配置文件-2" class="headerlink" title="1. 创建配置文件"></a>1. 创建配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-scheduler.conf &lt;&lt; EOF</span><br><span class="line">KUBE_SCHEDULER_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--leader-elect \\</span><br><span class="line">--kubeconfig=/opt/kubernetes/cfg/kube-scheduler.kubeconfig \\</span><br><span class="line">--bind-address=127.0.0.1&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>•   –kubeconfig：连接apiserver配置文件<br>•   –leader-elect：当该组件启动多个时，自动选举（HA）</p>
</blockquote>
<h4 id="2-生成kubeconfig文件-1"><a href="#2-生成kubeconfig文件-1" class="headerlink" title="2. 生成kubeconfig文件"></a>2. 生成kubeconfig文件</h4><blockquote>
<p><strong>生成kube-scheduler证书：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 切换工作目录</span><br><span class="line">cd ~/TLS/k8s</span><br><span class="line"></span><br><span class="line"># 创建证书请求文件</span><br><span class="line">cat &gt; kube-scheduler-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:masters&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 生成证书</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>生成kubeconfig文件（以下是shell命令，直接在终端执行）：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">KUBE_CONFIG=&quot;/opt/kubernetes/cfg/kube-scheduler.kubeconfig&quot;</span><br><span class="line">KUBE_APISERVER=&quot;https://192.168.71.101:6443&quot;</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br><span class="line">  </span><br><span class="line">kubectl config set-credentials kube-scheduler \</span><br><span class="line">  --client-certificate=./kube-scheduler.pem \</span><br><span class="line">  --client-key=./kube-scheduler-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br><span class="line">  </span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-scheduler \</span><br><span class="line">  --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br><span class="line">  </span><br><span class="line">kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-systemd管理scheduler"><a href="#3-systemd管理scheduler" class="headerlink" title="3. systemd管理scheduler"></a>3. systemd管理scheduler</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="4-启动并设置开机启动-1"><a href="#4-启动并设置开机启动-1" class="headerlink" title="4. 启动并设置开机启动"></a>4. 启动并设置开机启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-scheduler</span><br><span class="line">systemctl enable kube-scheduler</span><br></pre></td></tr></table></figure>

<h4 id="5-查看集群状态"><a href="#5-查看集群状态" class="headerlink" title="5. 查看集群状态"></a>5. 查看集群状态</h4><blockquote>
<p><strong>生成kubectl连接集群的证书：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; admin-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;admin&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:masters&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>生成kubeconfig文件：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/.kube</span><br><span class="line">KUBE_CONFIG=&quot;/root/.kube/config&quot;</span><br><span class="line">KUBE_APISERVER=&quot;https://192.168.71.101:6443&quot;</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br><span class="line">  </span><br><span class="line">kubectl config set-credentials cluster-admin \</span><br><span class="line">  --client-certificate=./admin.pem \</span><br><span class="line">  --client-key=./admin-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br><span class="line">  </span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=cluster-admin \</span><br><span class="line">  --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br><span class="line">  </span><br><span class="line">kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>通过kubectl工具查看当前集群组件状态：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs</span><br><span class="line">NAME                STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler             Healthy   ok                  </span><br><span class="line">controller-manager       Healthy   ok                  </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>如上输出说明Master节点组件运行正常。</strong></p>
<h4 id="6-授权kubelet-bootstrap用户允许请求证书"><a href="#6-授权kubelet-bootstrap用户允许请求证书" class="headerlink" title="6. 授权kubelet-bootstrap用户允许请求证书"></a>6. 授权kubelet-bootstrap用户允许请求证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">--clusterrole=system:node-bootstrapper \</span><br><span class="line">--user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>

<h2 id="五、部署Worker-Node"><a href="#五、部署Worker-Node" class="headerlink" title="五、部署Worker Node"></a>五、部署Worker Node</h2><p><strong>下面还是在Master Node上操作，即同时作为Worker Node</strong></p>
<h3 id="5-1-创建工作目录并拷贝二进制文件"><a href="#5-1-创建工作目录并拷贝二进制文件" class="headerlink" title="5.1 创建工作目录并拷贝二进制文件"></a>5.1 创建工作目录并拷贝二进制文件</h3><blockquote>
<p><strong>在所有worker node创建工作目录：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>从 Master 节点拷贝：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd kubernetes/server/bin</span><br><span class="line">cp kubelet kube-proxy /opt/kubernetes/bin   # 本地拷贝</span><br></pre></td></tr></table></figure>

<h3 id="5-2-部署kubelet"><a href="#5-2-部署kubelet" class="headerlink" title="5.2 部署kubelet"></a>5.2 部署kubelet</h3><h4 id="1-创建配置文件-3"><a href="#1-创建配置文件-3" class="headerlink" title="1. 创建配置文件"></a>1. 创建配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kubelet.conf &lt;&lt; EOF</span><br><span class="line">KUBELET_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--hostname-override=k8s-master1 \\</span><br><span class="line">--network-plugin=cni \\</span><br><span class="line">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\</span><br><span class="line">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\</span><br><span class="line">--config=/opt/kubernetes/cfg/kubelet-config.yml \\</span><br><span class="line">--cert-dir=/opt/kubernetes/ssl \\</span><br><span class="line">--pod-infra-container-image=lizhenliang/pause-amd64:3.0&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>•   –hostname-override：显示名称，集群中唯一<br>•   –network-plugin：启用CNI<br>•   –kubeconfig：空路径，会自动生成，后面用于连接apiserver<br>•   –bootstrap-kubeconfig：首次启动向apiserver申请证书<br>•   –config：配置参数文件<br>•   –cert-dir：kubelet证书生成目录<br>•   –pod-infra-container-image：管理Pod网络容器的镜像</p>
</blockquote>
<h4 id="2-配置参数文件"><a href="#2-配置参数文件" class="headerlink" title="2. 配置参数文件"></a>2. 配置参数文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kubelet-config.yml &lt;&lt; EOF</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.0.0.2</span><br><span class="line">clusterDomain: cluster.local </span><br><span class="line">failSwapOn: false</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /opt/kubernetes/ssl/ca.pem </span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="3-生成kubelet初次加入集群引导kubeconfig文件"><a href="#3-生成kubelet初次加入集群引导kubeconfig文件" class="headerlink" title="3. 生成kubelet初次加入集群引导kubeconfig文件"></a>3. 生成kubelet初次加入集群引导kubeconfig文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">KUBE_CONFIG=&quot;/opt/kubernetes/cfg/bootstrap.kubeconfig&quot;</span><br><span class="line">KUBE_APISERVER=&quot;https://192.168.71.101:6443&quot; # apiserver IP:PORT</span><br><span class="line">TOKEN=&quot;f23ebd28bc62745fb1d7d8c150016a06&quot; # 与token.csv里保持一致</span><br><span class="line"></span><br><span class="line"># 生成 kubelet bootstrap kubeconfig 配置文件</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials &quot;kubelet-bootstrap&quot; \</span><br><span class="line">  --token=$&#123;TOKEN&#125; \</span><br><span class="line">  --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br><span class="line"></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=&quot;kubelet-bootstrap&quot; \</span><br><span class="line">  --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br><span class="line"></span><br><span class="line">kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-systemd管理kubelet"><a href="#4-systemd管理kubelet" class="headerlink" title="4. systemd管理kubelet"></a>4. systemd管理kubelet</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="5-启动并设置开机启动-2"><a href="#5-启动并设置开机启动-2" class="headerlink" title="5. 启动并设置开机启动"></a>5. 启动并设置开机启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl enable kubelet</span><br></pre></td></tr></table></figure>

<h3 id="5-3-批准kubelet证书申请并加入集群"><a href="#5-3-批准kubelet证书申请并加入集群" class="headerlink" title="5.3 批准kubelet证书申请并加入集群"></a>5.3 批准kubelet证书申请并加入集群</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 查看kubelet证书请求</span><br><span class="line">kubectl get csr</span><br><span class="line">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">node-csr-xe7gHa5Ja1victiB0QTBRX9LKijMOjMkm4FL2ZEtz8s   12s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line"></span><br><span class="line"># 批准申请</span><br><span class="line">kubectl certificate approve node-csr-xe7gHa5Ja1victiB0QTBRX9LKijMOjMkm4FL2ZEtz8s</span><br><span class="line"></span><br><span class="line"># 查看节点</span><br><span class="line">kubectl get node</span><br><span class="line">NAME         STATUS     ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   NotReady   &lt;none&gt;   6s    v1.20.6</span><br></pre></td></tr></table></figure>

<p>注：由于网络插件还没有部署，节点会没有准备就绪 NotReady</p>
<h3 id="5-4-部署kube-proxy"><a href="#5-4-部署kube-proxy" class="headerlink" title="5.4 部署kube-proxy"></a>5.4 部署kube-proxy</h3><h4 id="1-创建配置文件-4"><a href="#1-创建配置文件-4" class="headerlink" title="1. 创建配置文件"></a>1. 创建配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-proxy.conf &lt;&lt; EOF</span><br><span class="line">KUBE_PROXY_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--config=/opt/kubernetes/cfg/kube-proxy-config.yml&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="2-配置参数文件-1"><a href="#2-配置参数文件-1" class="headerlink" title="2. 配置参数文件"></a>2. 配置参数文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-proxy-config.yml &lt;&lt; EOF</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">metricsBindAddress: 0.0.0.0:10249</span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig</span><br><span class="line">hostnameOverride: k8s-master1</span><br><span class="line">clusterCIDR: 10.0.0.0/24</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="3-生成kube-proxy-kubeconfig文件"><a href="#3-生成kube-proxy-kubeconfig文件" class="headerlink" title="3. 生成kube-proxy.kubeconfig文件"></a>3. 生成kube-proxy.kubeconfig文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># 切换工作目录</span><br><span class="line">cd ~/TLS/k8s</span><br><span class="line"></span><br><span class="line"># 创建证书请求文件</span><br><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 生成证书</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line"></span><br><span class="line"># 生成kubeconfig文件：</span><br><span class="line">KUBE_CONFIG=&quot;/opt/kubernetes/cfg/kube-proxy.kubeconfig&quot;</span><br><span class="line">KUBE_APISERVER=&quot;https://192.168.71.101:6443&quot;</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br><span class="line">  </span><br><span class="line">kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=./kube-proxy.pem \</span><br><span class="line">  --client-key=./kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br><span class="line">  </span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br><span class="line">  </span><br><span class="line">kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-systemd管理kube-proxy"><a href="#4-systemd管理kube-proxy" class="headerlink" title="4. systemd管理kube-proxy"></a>4. systemd管理kube-proxy</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="5-启动并设置开机启动-3"><a href="#5-启动并设置开机启动-3" class="headerlink" title="5. 启动并设置开机启动"></a>5. 启动并设置开机启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-proxy</span><br><span class="line">systemctl enable kube-proxy</span><br></pre></td></tr></table></figure>

<h3 id="5-5-部署网络组件"><a href="#5-5-部署网络组件" class="headerlink" title="5.5 部署网络组件"></a>5.5 部署网络组件</h3><p>Calico是一个纯三层的数据中心网络方案，是目前Kubernetes主流的网络方案。</p>
<p>部署Calico：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f calico.yaml</span><br><span class="line"></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-5d47c9d59f-jxktk   1/1     Running   0          2m</span><br><span class="line">calico-node-pmwq2                          1/1     Running   0          2m</span><br></pre></td></tr></table></figure>

<p>等Calico Pod都Running，节点也会准备就绪：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">NAME          STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   Ready    &lt;none&gt;   11m   v1.20.6</span><br></pre></td></tr></table></figure>

<h3 id="5-6-授权apiserver访问kubelet"><a href="#5-6-授权apiserver访问kubelet" class="headerlink" title="5.6 授权apiserver访问kubelet"></a>5.6 授权apiserver访问kubelet</h3><p>应用场景：例如 kubectl logs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; apiserver-to-kubelet-rbac.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - nodes/proxy</span><br><span class="line">      - nodes/stats</span><br><span class="line">      - nodes/log</span><br><span class="line">      - nodes/spec</span><br><span class="line">      - nodes/metrics</span><br><span class="line">      - pods/log</span><br><span class="line">    verbs:</span><br><span class="line">      - &quot;*&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-apiserver</span><br><span class="line">  namespace: &quot;&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">subjects:</span><br><span class="line">  - apiGroup: rbac.authorization.k8s.io</span><br><span class="line">    kind: User</span><br><span class="line">    name: kubernetes</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f apiserver-to-kubelet-rbac.yaml</span><br></pre></td></tr></table></figure>

<h3 id="5-7-新增加Worker-Node"><a href="#5-7-新增加Worker-Node" class="headerlink" title="5.7 新增加Worker Node"></a>5.7 新增加Worker Node</h3><h4 id="1-拷贝已部署好的-Node节点相关文件到两台-Node-节点"><a href="#1-拷贝已部署好的-Node节点相关文件到两台-Node-节点" class="headerlink" title="1. 拷贝已部署好的 Node节点相关文件到两台 Node 节点"></a>1. 拷贝已部署好的 Node节点相关文件到两台 Node 节点</h4><blockquote>
<p>在Master节点将Worker Node涉及文件拷贝到 Node 节点192.168.71.102/103</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">scp -r /opt/kubernetes root@192.168.71.102:/opt/</span><br><span class="line">scp -r /opt/kubernetes root@192.168.71.103:/opt/</span><br><span class="line"></span><br><span class="line">scp -r /usr/lib/systemd/system/&#123;kubelet,kube-proxy&#125;.service root@192.168.71.102:/usr/lib/systemd/system</span><br><span class="line">scp -r /usr/lib/systemd/system/&#123;kubelet,kube-proxy&#125;.service root@192.168.71.103:/usr/lib/systemd/system</span><br></pre></td></tr></table></figure>

<h4 id="2-删除kubelet证书和kubeconfig文件"><a href="#2-删除kubelet证书和kubeconfig文件" class="headerlink" title="2. 删除kubelet证书和kubeconfig文件"></a>2. 删除kubelet证书和kubeconfig文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -f /opt/kubernetes/cfg/kubelet.kubeconfig </span><br><span class="line">rm -f /opt/kubernetes/ssl/kubelet*</span><br></pre></td></tr></table></figure>

<p>注：这几个文件是证书申请审批后自动生成的，每个Node不同，必须删除</p>
<h4 id="3-修改主机名（192-168-71-102-103两台都要改）k8s-node1、k8s-node2"><a href="#3-修改主机名（192-168-71-102-103两台都要改）k8s-node1、k8s-node2" class="headerlink" title="3. 修改主机名（192.168.71.102/103两台都要改）k8s-node1、k8s-node2"></a>3. 修改主机名（192.168.71.102/103两台都要改）k8s-node1、k8s-node2</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /opt/kubernetes/cfg/kubelet.conf</span><br><span class="line">--hostname-override=k8s-node1</span><br><span class="line"></span><br><span class="line">vi /opt/kubernetes/cfg/kube-proxy-config.yml</span><br><span class="line">hostnameOverride: k8s-node1</span><br></pre></td></tr></table></figure>

<h4 id="4-启动并设置开机启动-2"><a href="#4-启动并设置开机启动-2" class="headerlink" title="4. 启动并设置开机启动"></a>4. 启动并设置开机启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kubelet kube-proxy</span><br><span class="line">systemctl enable kubelet kube-proxy</span><br></pre></td></tr></table></figure>

<h4 id="5-在Master上批准新Node-kubelet证书申请"><a href="#5-在Master上批准新Node-kubelet证书申请" class="headerlink" title="5. 在Master上批准新Node kubelet证书申请"></a>5. 在Master上批准新Node kubelet证书申请</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 查看证书请求</span><br><span class="line">kubectl get csr</span><br><span class="line">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">node-csr-lCJ_OmTB00VWRrGxUXtZXnLdwZ1rwXGYiDyiGnYKFqg   74s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line">node-csr-m5dbNEgedpTI8Oo6JrZbDMWy_ugrrh9CZFXjO9q-agE   74s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line">node-csr-xe7gHa5Ja1victiB0QTBRX9LKijMOjMkm4FL2ZEtz8s   33m   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line"></span><br><span class="line"># 授权请求</span><br><span class="line">kubectl certificate approve node-csr-lCJ_OmTB00VWRrGxUXtZXnLdwZ1rwXGYiDyiGnYKFqg</span><br><span class="line">kubectl certificate approve node-csr-m5dbNEgedpTI8Oo6JrZbDMWy_ugrrh9CZFXjO9q-agE</span><br></pre></td></tr></table></figure>

<h4 id="6-查看Node状态"><a href="#6-查看Node状态" class="headerlink" title="6. 查看Node状态"></a>6. 查看Node状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">NAME          STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   Ready    &lt;none&gt;   33m   v1.20.6</span><br><span class="line">k8s-node1     Ready    &lt;none&gt;   63s   v1.20.6</span><br><span class="line">k8s-node2     Ready    &lt;none&gt;   91s   v1.20.6</span><br></pre></td></tr></table></figure>

<h2 id="六、部署Dashboard和CoreDNS"><a href="#六、部署Dashboard和CoreDNS" class="headerlink" title="六、部署Dashboard和CoreDNS"></a>六、部署Dashboard和CoreDNS</h2><h3 id="1-部署Dashboard"><a href="#1-部署Dashboard" class="headerlink" title="1. 部署Dashboard"></a>1. 部署Dashboard</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kubernetes-dashboard.yaml</span><br><span class="line"> </span><br><span class="line"># 查看部署</span><br><span class="line">kubectl get pod,svc -n kubernetes-dashboard</span><br><span class="line"> </span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/dashboard-metrics-scraper-7445d59dfd-5vh2x   1/1     Running   0          41s</span><br><span class="line">pod/kubernetes-dashboard-8795df748-r6qtv         1/1     Running   0          41s</span><br><span class="line"> </span><br><span class="line">NAME                                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">service/dashboard-metrics-scraper   ClusterIP   10.0.0.206   &lt;none&gt;        8000/TCP        41s</span><br><span class="line">service/kubernetes-dashboard        NodePort    10.0.0.63    &lt;none&gt;        443:30001/TCP   42s</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>创建管理员账户：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; dashboard-admin.yaml &lt;&lt;EOF </span><br><span class="line">apiVersion: v1 </span><br><span class="line">kind: ServiceAccount </span><br><span class="line">metadata: </span><br><span class="line">  labels: </span><br><span class="line">    k8s-app: kubernetes-dashboard </span><br><span class="line">  name: dashboard-admin </span><br><span class="line">  namespace: kubernetes-dashboard </span><br><span class="line">--- </span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1 </span><br><span class="line">kind: ClusterRoleBinding </span><br><span class="line">metadata: </span><br><span class="line">  name: dashboard-admin-bind-cluster-role </span><br><span class="line">  labels: </span><br><span class="line">    k8s-app: kubernetes-dashboard </span><br><span class="line">roleRef: </span><br><span class="line">  apiGroup: rbac.authorization.k8s.io </span><br><span class="line">  kind: ClusterRole </span><br><span class="line">  name: cluster-admin </span><br><span class="line">subjects: </span><br><span class="line">- kind: ServiceAccount </span><br><span class="line">  name: dashboard-admin </span><br><span class="line">  namespace: kubernetes-dashboard </span><br><span class="line">EOF</span><br><span class="line"> </span><br><span class="line">kubectl apply -f dashboard-admin.yaml</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>获取管理员Token</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep dashboard-admin | awk &apos;&#123;print $1&#125;&apos;)</span><br></pre></td></tr></table></figure>

<p><strong>使用输出的token登录Dashboard</strong></p>
<p><a href="https://NodeIP:Port" target="_blank" rel="noopener">https://NodeIP:Port</a></p>
<p><img src="https://img-blog.csdnimg.cn/20210510193348470.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODc3OTI1OA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p><strong>Chrome</strong>如果提示以上错误，在<strong>Chrome</strong>该页面上，直接键盘敲入这11个字符：thisisunsafe **即可</p>
<p><img src="https://img-blog.csdnimg.cn/20210510193534102.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODc3OTI1OA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20210510193553676.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODc3OTI1OA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="2-部署CoreDNS"><a href="#2-部署CoreDNS" class="headerlink" title="2. 部署CoreDNS"></a>2. 部署CoreDNS</h3><p>CoreDNS用于集群内部Service名称解析。</p>
<h4 id="一、准备yaml配置文件"><a href="#一、准备yaml配置文件" class="headerlink" title="一、准备yaml配置文件"></a>一、准备yaml配置文件</h4><blockquote>
<p> <strong>1、coredns-sa.yaml文件，创建ServiceAccount</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat coredns-sa.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">      kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">      addonmanager.kubernetes.io/mode: Reconcile</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>2、coredns-rbac.yaml文件，创建rbac ClusterRole和ClusterRoleBinding</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">cat coredns-sa.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">      kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">      addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">[root@k8s-master1 coredns]# cat coredns-rbac.yaml </span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: system:coredns</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - endpoints</span><br><span class="line">  - services</span><br><span class="line">  - pods</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">  name: system:coredns</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:coredns</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>3、coredns-configmap.yaml文件，定义Corefile配置文件的参数配置</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat coredns-configmap.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        log</span><br><span class="line">        health</span><br><span class="line">        kubernetes cluster.local 10.0.0.0/24</span><br><span class="line">        forward . /etc/resolv.conf</span><br><span class="line">        cache 30</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>4、coredns-deployment.yaml文件，定义pod的创建模板</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">cat coredns-deployment.yaml </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    kubernetes.io/name: &quot;CoreDNS&quot;</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: coredns</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: coredns</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: &apos;&apos;</span><br><span class="line">        scheduler.alpha.kubernetes.io/tolerations: &apos;[&#123;&quot;key&quot;:&quot;CriticalAddonsOnly&quot;, &quot;operator&quot;:&quot;Exists&quot;&#125;]&apos;</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: coredns</span><br><span class="line">      containers:</span><br><span class="line">      - name: coredns</span><br><span class="line">        image: coredns/coredns:latest</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        args: [ &quot;-conf&quot;, &quot;/etc/coredns/Corefile&quot; ]</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: /etc/coredns</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns-tcp</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /health</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">      dnsPolicy: Default</span><br><span class="line">      volumes:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          configMap:</span><br><span class="line">            name: coredns</span><br><span class="line">            items:</span><br><span class="line">            - key: Corefile</span><br><span class="line">              path: Corefile</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>5、 coredns-service.yaml文件，定义服务的名称</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat coredns-service.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    kubernetes.io/name: &quot;CoreDNS&quot;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">  clusterIP: 10.0.0.2</span><br><span class="line">  ports:</span><br><span class="line">  - name: dns</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: UDP</span><br><span class="line">  - name: dns-tcp</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: TCP</span><br></pre></td></tr></table></figure>

<h4 id="二、通过yaml配置文件创建coredns"><a href="#二、通过yaml配置文件创建coredns" class="headerlink" title="二、通过yaml配置文件创建coredns"></a>二、通过yaml配置文件创建coredns</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls –l</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20210510193838912.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODc3OTI1OA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f .</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20210510193859162.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODc3OTI1OA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deploy,pod,svc -n kube-system | grep coredns</span><br><span class="line"> </span><br><span class="line">deployment.apps/coredns                   1/1     1            1           82s</span><br><span class="line">pod/coredns-6df4658f78-dcdz7                   1/1     Running   0          80s</span><br><span class="line">service/coredns   ClusterIP   10.0.0.2     &lt;none&gt;        53/UDP,53/TCP   81s</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>DNS解析测试：</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl run -it --rm dns-test --image=busybox:1.28.4 sh</span><br><span class="line">If you don&apos;t see a command prompt, try pressing enter.</span><br><span class="line">/ # nslookup kubernetes</span><br><span class="line">Server:    10.0.0.2</span><br><span class="line">Address 1: 10.0.0.2 coredns.kube-system.svc.lluster.local</span><br><span class="line"> </span><br><span class="line">Name:      kubernetes</span><br><span class="line">Address 1: 10.0.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure>

<p><strong>解析没问题。</strong></p>
<p><strong>至此一个单Master集群就搭建完成了！如果服务器配置较高，可继续扩容多Master集群！</strong></p>
<h2 id="七、部署Ingress-nginx-0-30"><a href="#七、部署Ingress-nginx-0-30" class="headerlink" title="七、部署Ingress nginx 0.30"></a>七、部署Ingress nginx 0.30</h2><h3 id="1-Ingress概述"><a href="#1-Ingress概述" class="headerlink" title="1. Ingress概述"></a>1. Ingress概述</h3><p>Ingress 是对集群中服务的外部访问进行管理的 API 对象，典型的访问方式是 HTTP和HTTPS。</p>
<p>Ingress 可以提供负载均衡、SSL 和基于名称的虚拟托管。</p>
<p>必须具有 ingress 控制器【例如 ingress-nginx】才能满足 Ingress 的要求。仅创建 Ingress 资源无效。</p>
<h3 id="2-Ingress-是什么"><a href="#2-Ingress-是什么" class="headerlink" title="2. Ingress 是什么"></a>2. Ingress 是什么</h3><p>Ingress 公开了从集群外部到集群内 services 的 HTTP 和 HTTPS 路由。 流量路由由 Ingress 资源上定义的规则控制。</p>
<blockquote>
<p>1  internet<br>2       |<br>3 [ Ingress ]<br>4 –|—–|–<br>5 [ Services ]</p>
</blockquote>
<p>可以将 Ingress 配置为提供服务外部可访问的 URL、负载均衡流量、 SSL / TLS，以及提供基于名称的虚拟主机。Ingress 控制器 通常负责通过负载均衡器来实现 Ingress，尽管它也可以配置边缘路由器或其他前端来帮助处理流量。</p>
<p>Ingress 不会公开任意端口或协议。若将 HTTP 和 HTTPS 以外的服务公开到 Internet 时，通常使用 Service.Type=NodePort 或者 Service.Type=LoadBalancer 类型的服务。<br><img src="https://img-blog.csdnimg.cn/img_convert/5d393aed9aa4762e6ce5a4ef9caf85e9.png" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/5c4195de35df7bf0950f46264a14d838.png" alt="img"></p>
<h3 id="3-部署Ingress-Nginx"><a href="#3-部署Ingress-Nginx" class="headerlink" title="3. 部署Ingress-Nginx"></a>3. 部署Ingress-Nginx</h3><p>该Nginx是经过改造的，而不是传统的Nginx。</p>
<blockquote>
<p><strong>Ingress-Nginx官网地址</strong></p>
</blockquote>
<p><a href="https://kubernetes.github.io/ingress-nginx/" target="_blank" rel="noopener">https://kubernetes.github.io/ingress-nginx/</a></p>
<blockquote>
<p><strong>Ingress-Nginx GitHub地址</strong></p>
</blockquote>
<p><a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">https://github.com/kubernetes/ingress-nginx</a></p>
<blockquote>
<p><strong>本次部署版本：nginx-0.30.0</strong></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/img_convert/59a93043569348641ca7d39f62a626ad.png" alt="img"></p>
<p>ingress-nginx的yaml文件修改后并启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 当前目录</span><br><span class="line">pwd</span><br><span class="line">/root/ingress</span><br><span class="line"></span><br><span class="line"># 解压</span><br><span class="line">ls</span><br><span class="line">ingress-nginx-nginx-0.30.0.tar.gz</span><br><span class="line"></span><br><span class="line">tar -xf ingress-nginx-nginx-0.30.0.tar.gz</span><br><span class="line"></span><br><span class="line"># yaml文件在下载包中的位置：ingress-nginx-nginx-0.30.0/deploy/static/mandatory.yaml</span><br><span class="line">cp ingress-nginx-nginx-0.30.0/deploy/static/mandatory.yaml ./</span><br><span class="line"></span><br><span class="line"># yaml文件配置修改（在serviceAccountName添加以下一行）</span><br><span class="line"> hostNetwork: true 	# 使用宿主机网络</span><br><span class="line"> </span><br><span class="line"># 创建ingress</span><br><span class="line">kubectl apply -f mandatory.yaml</span><br><span class="line"></span><br><span class="line"># 查看deployment</span><br><span class="line"> kubectl get deploy -n ingress-nginx -owide</span><br><span class="line">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS                 IMAGES                                                                  SELECTOR</span><br><span class="line">nginx-ingress-controller   1/1     1            1           47s   nginx-ingress-controller   quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0   app.kubernetes.io/name=ingress-nginx,app.kubernetes.io/part-of=ingress-nginx</span><br><span class="line"></span><br><span class="line"># 查看pod</span><br><span class="line">kubectl get po -n ingress-nginx -o wide</span><br><span class="line">NAME                                        READY   STATUS    RESTARTS   AGE   IP               NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-ingress-controller-7d4544b644-slgjr   1/1     Running   0          1m32s   192.168.71.103   k8s-node2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h3 id="4-deploy-service的yaml信息"><a href="#4-deploy-service的yaml信息" class="headerlink" title="4. deploy_service的yaml信息"></a>4. deploy_service的yaml信息</h3><blockquote>
<p><strong>yaml文件</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">pwd</span><br><span class="line">/root/ingress</span><br><span class="line"></span><br><span class="line">cat deplopy_service.yaml </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: myapp</span><br><span class="line">      release: v1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: myapp</span><br><span class="line">        release: v1</span><br><span class="line">        env: test</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: myapp</span><br><span class="line">        image: registry.cn-beijing.aliyuncs.com/google_registry/myapp:v1</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-service</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  type: ClusterIP  # 默认类型</span><br><span class="line">  selector:</span><br><span class="line">    app: myapp</span><br><span class="line">    release: v1</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>启动Deployment和Service</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f deplopy_service.yaml</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>查看Deployment、Service、Pod</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deploy,po,svc -o wide</span><br><span class="line">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES                                                      SELECTOR</span><br><span class="line">deployment.apps/myapp-deploy   3/3     3            3           3m15s   myapp        registry.cn-beijing.aliyuncs.com/google_registry/myapp:v1   app=myapp,release=v1</span><br><span class="line"></span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE   IP             NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/myapp-deploy-6c468d6b6c-56mf9   1/1     Running   0          36s   10.100.0.207   k8s-node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/myapp-deploy-6c468d6b6c-r9brp   1/1     Running   0          36s   10.100.0.80    k8s-node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/myapp-deploy-6c468d6b6c-x7jzq   1/1     Running   0          36s   10.100.0.81    k8s-node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE     SELECTOR</span><br><span class="line">service/kubernetes      ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP   3d19h   &lt;none&gt;</span><br><span class="line">service/myapp-service   ClusterIP   10.0.0.113   &lt;none&gt;        80/TCP    36s     app=myapp,release=v1</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>curl访问pod</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">url 10.100.0.207</span><br><span class="line">Hello MyApp | Version: v1 | &lt;a href=&quot;hostname.html&quot;&gt;Pod Name&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">curl 10.100.0.80/hostname.html</span><br><span class="line">myapp-deploy-6c468d6b6c-r9brp</span><br><span class="line"></span><br><span class="line">curl 10.100.0.81/hostname.html</span><br><span class="line">myapp-deploy-6c468d6b6c-x7jzq</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>curl访问svc</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl 10.0.0.113/hostname.html</span><br><span class="line">myapp-deploy-6c468d6b6c-x7jzq</span><br><span class="line"></span><br><span class="line">curl 10.0.0.113/hostname.html</span><br><span class="line">myapp-deploy-6c468d6b6c-r9brp</span><br><span class="line"></span><br><span class="line">curl 10.0.0.113/hostname.html</span><br><span class="line">myapp-deploy-6c468d6b6c-x7jzq</span><br></pre></td></tr></table></figure>

<h3 id="5-Ingress-HTTP代理访问"><a href="#5-Ingress-HTTP代理访问" class="headerlink" title="5. Ingress HTTP代理访问"></a>5. Ingress HTTP代理访问</h3><p><strong>yaml文件【由于自建的service在默认default名称空间，因此这里也是default名称空间】</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwd</span><br><span class="line">/root/ingress</span><br><span class="line"></span><br><span class="line">cat ingress-http.yaml </span><br><span class="line">apiVersion: networking.k8s.io/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-http</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">    - host: www.renching.com</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">        - path: /</span><br><span class="line">          backend:</span><br><span class="line">            serviceName: myapp-service</span><br><span class="line">            servicePort: 80</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>启动ingress http并查看状态</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f ingress-http.yaml</span><br><span class="line"></span><br><span class="line">kubectl get ingress -o wide</span><br><span class="line">NAME         CLASS    HOSTS              ADDRESS   PORTS     AGE</span><br><span class="line">nginx-http   &lt;none&gt;   www.renching.com             80	     9s</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>查看nginx配置文件</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -A | grep ingress</span><br><span class="line">ingress-nginx          nginx-ingress-controller-7d4544b644-slgjr    1/1     Running   0          10m</span><br><span class="line"></span><br><span class="line">kubectl exec -it -n ingress-nginx nginx-ingress-controller-7d4544b644-slgjr bash</span><br><span class="line">bash-5.0$ grep &quot;www.renching.com&quot; /etc/nginx/nginx.conf</span><br><span class="line">	## start server www.renching.com</span><br><span class="line">		server_name www.renching.com ;</span><br><span class="line">	## end server www.renching.com</span><br></pre></td></tr></table></figure>

<h3 id="6-浏览器访问"><a href="#6-浏览器访问" class="headerlink" title="6. 浏览器访问"></a>6. 浏览器访问</h3><p><strong>由于没有解析dns需要先修改hosts文件再进行域名访问</strong></p>
<blockquote>
<p><strong>浏览器访问<a href="http://www.renching.com" target="_blank" rel="noopener">www.renching.com</a></strong></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/20210511110328658.png" alt="在这里插入图片描述"></p>
<p><strong>当然：除了用浏览器访问外，也可以在Linux使用curl访问。前提是修改/etc/hosts文件，对上面的域名进行解析。</strong></p>
<h3 id="6-Ingress-HTTPS代理访问"><a href="#6-Ingress-HTTPS代理访问" class="headerlink" title="6. Ingress HTTPS代理访问"></a>6. Ingress HTTPS代理访问</h3><blockquote>
<p><strong>SSL证书创建</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwd</span><br><span class="line">/root/ingress/cert</span><br><span class="line"></span><br><span class="line">openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/C=CN/ST=BJ/L=BeiJing/O=BTC/OU=MOST/CN=ren/emailAddress=ca@test.com&quot;</span><br><span class="line"></span><br><span class="line">kubectl create secret tls tls-secret --key tls.key --cert tls.crt</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>创建ingress https</strong></p>
</blockquote>
<p><strong>yaml文件【由于自建的service在默认default名称空间，因此这里也是default名称空间】</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwd</span><br><span class="line">/root/ingress</span><br><span class="line"></span><br><span class="line">cat ingress-https.yaml </span><br><span class="line">apiVersion: networking.k8s.io/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-http</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">    - hosts:</span><br><span class="line">      - www.renching.com</span><br><span class="line">      secretName: tls-secret</span><br><span class="line">  rules:</span><br><span class="line">    - host: www.renching.com</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">        - path: /</span><br><span class="line">          backend:</span><br><span class="line">            serviceName: myapp-service</span><br><span class="line">            servicePort: 80</span><br></pre></td></tr></table></figure>

<h3 id="7-启动ingress-https并查看状态"><a href="#7-启动ingress-https并查看状态" class="headerlink" title="7. 启动ingress https并查看状态"></a>7. 启动ingress https并查看状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f ingress-https.yaml </span><br><span class="line"></span><br><span class="line">kubectl get ingress </span><br><span class="line">NAME         CLASS    HOSTS              ADDRESS   PORTS     AGE</span><br><span class="line">nginx-http   &lt;none&gt;   www.renching.com             80, 443   8s</span><br></pre></td></tr></table></figure>

<h3 id="8-浏览器访问"><a href="#8-浏览器访问" class="headerlink" title="8. 浏览器访问"></a>8. 浏览器访问</h3><p><strong>由于没有解析dns需要先修改hosts文件再进行域名访问</strong></p>
<blockquote>
<p><strong>浏览器访问 <a href="https://www.renching.com" target="_blank" rel="noopener">https://www.renching.com</a></strong></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/20210511111024867.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODc3OTI1OA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p><strong>当然：除了用浏览器访问外，也可以在Linux使用curl访问。前提是修改/etc/hosts文件，对上面的域名进行解析。</strong></p>
<h2 id="八-安装-Metrics-Server"><a href="#八-安装-Metrics-Server" class="headerlink" title="八. 安装 Metrics- Server"></a>八. 安装 Metrics- Server</h2><h3 id="1-部署-Metrics-Server"><a href="#1-部署-Metrics-Server" class="headerlink" title="1 部署 Metrics Server"></a>1 部署 Metrics Server</h3><h5 id="下载-YAML-文件"><a href="#下载-YAML-文件" class="headerlink" title="下载 YAML 文件"></a>下载 YAML 文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget -O metrics-server.yaml https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.4.1/components.yaml</span><br></pre></td></tr></table></figure>

<h5 id="修改-Metrics-Server-的启动参数"><a href="#修改-Metrics-Server-的启动参数" class="headerlink" title="修改 Metrics Server 的启动参数"></a>修改 Metrics Server 的启动参数</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ vim components.yaml</span><br><span class="line"></span><br><span class="line">#  --kubelet-insecure-tls 跳过 TLS 认证，否则会出现 x509 的认证问题，用于测试环境。</span><br><span class="line">#  --kubelet-preferred-address-types=InternalIP 使用 Node IP 进行通信。</span><br><span class="line">      - args:</span><br><span class="line">        - --cert-dir=/tmp</span><br><span class="line">        - --secure-port=4443</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP</span><br><span class="line">        - --kubelet-use-node-status-port</span><br><span class="line">        - --kubelet-insecure-tls</span><br></pre></td></tr></table></figure>

<h5 id="部署-Metrics-Server"><a href="#部署-Metrics-Server" class="headerlink" title="部署 Metrics Server"></a>部署 Metrics Server</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f metrics-server.yaml</span><br><span class="line">serviceaccount/metrics-server created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:metrics-server created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created</span><br><span class="line">service/metrics-server created</span><br><span class="line">deployment.apps/metrics-server created</span><br><span class="line">apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created</span><br></pre></td></tr></table></figure>

<h5 id="检查-Metrics-Server-Pod状态"><a href="#检查-Metrics-Server-Pod状态" class="headerlink" title="检查 Metrics Server Pod状态"></a>检查 Metrics Server Pod状态</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -n kube-system | grep metrics-server</span><br><span class="line">metrics-server-bfcc967d6-czfbg       0/1     ImagePullBackOff   0          20m</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意：如果出现了 ErrImagePull 的问题，那么意味着 k8s.gcr.io/metrics-server/metrics-server:v0.4.1 镜像下载失败</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull k8s.gcr.io/metrics-server/metrics-server:v0.4.1</span><br><span class="line">Error response from daemon: Get https://k8s.gcr.io/v2/: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)</span><br></pre></td></tr></table></figure>

<h5 id="手动下载-Metrics-Server-镜像"><a href="#手动下载-Metrics-Server-镜像" class="headerlink" title="手动下载 Metrics Server 镜像"></a>手动下载 Metrics Server 镜像</h5><blockquote>
<p><strong>这时候就需要我们在每个节点上都手动下载镜像</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull bitnami/metrics-server:0.4.1</span><br><span class="line"></span><br><span class="line">$ docker tag bitnami/metrics-server:0.4.1 k8s.gcr.io/metrics-server/metrics-server:v0.4.1</span><br><span class="line"></span><br><span class="line">$ docker images | grep metrics-server</span><br><span class="line">bitnami/metrics-server                                            0.4.1               e996b9ba65f9        7 weeks ago         171MB</span><br><span class="line">k8s.gcr.io/metrics-server/metrics-server                          v0.4.1              e996b9ba65f9        7 weeks ago         171MB</span><br></pre></td></tr></table></figure>

<h5 id="部署-Metrics-Server-1"><a href="#部署-Metrics-Server-1" class="headerlink" title="部署 Metrics Server"></a>部署 Metrics Server</h5><blockquote>
<p><strong>然后再次执行 Metrics Server 的部署指令</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f metrics-server.yaml</span><br></pre></td></tr></table></figure>

<h5 id="检查-Metrics-Server-Pod状态-1"><a href="#检查-Metrics-Server-Pod状态-1" class="headerlink" title="检查 Metrics Server Pod状态"></a>检查 Metrics Server Pod状态</h5><blockquote>
<p><strong>以下看到是 Running，那么意味着 metrics-server pod 状态为运行状态</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -n kube-system | grep metrics-server</span><br><span class="line">metrics-server-bfcc967d6-czfbg       1/1     Running   0          26m</span><br></pre></td></tr></table></figure>

<h5 id="检查-Metrics-Server-Service"><a href="#检查-Metrics-Server-Service" class="headerlink" title="检查 Metrics Server Service"></a>检查 Metrics Server Service</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc --all-namespaces | grep metrics-server</span><br><span class="line">kube-system            metrics-server              ClusterIP   10.10.77.65     &lt;none&gt;        443/TCP                  29m</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>检查 API Server 是否可以连通 Metrics Server</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe svc metrics-server -n kube-system</span><br><span class="line">Name:              metrics-server</span><br><span class="line">Namespace:         kube-system</span><br><span class="line">Labels:            k8s-app=metrics-server</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          k8s-app=metrics-server</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.10.77.65</span><br><span class="line">Port:              https  443/TCP</span><br><span class="line">TargetPort:        https/TCP</span><br><span class="line">Endpoints:         10.244.2.3:4443</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h3 id="3-检查-Metrics-Server-是否可用"><a href="#3-检查-Metrics-Server-是否可用" class="headerlink" title="3 检查 Metrics Server 是否可用"></a>3 检查 Metrics Server 是否可用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl top nodes</span><br><span class="line">NAME         CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">k8s-master1   76m          3%     1046Mi          60%       </span><br><span class="line">k8s-node1    20m          1%     737Mi           42%       </span><br><span class="line">k8s-node2    20m          1%     712Mi           41%</span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">RenChing Doe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2021/12/27/使用二进制部署-K8S-单-Master-集群V1-20/">http://yoursite.com/2021/12/27/使用二进制部署-K8S-单-Master-集群V1-20/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes    </a><a class="post-meta__tags" href="/tags/K8S/">K8S    </a></div><div class="post_share"><div class="social-share" data-image="https://img-blog.csdnimg.cn/5494d8aa7bfa4b0d91b4b9a3f6388710.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUmVuQ2hpbmc=,size_20,color_FFFFFF,t_70,g_se,x_16" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-buttom"><i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/alipay.jpg"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2021/12/27/基于-Docker-compose-部署-Jumpserver-堡垒机/"><img class="prev_cover lozad" data-src="https://img-blog.csdnimg.cn/d58b4d74481a48a8af1c752883c7be34.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUmVuQ2hpbmc=,size_20,color_FFFFFF,t_70,g_se,x_16" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Previous Post</div><div class="prev_info"><span>基于 Docker-compose 部署 Jumpserver 堡垒机</span></div></a></div><div class="next-post pull-right"><a href="/2021/12/27/使用-Kubeadm-部署-K8S-集群V1-19-0/"><img class="next_cover lozad" data-src="https://img-blog.csdnimg.cn/20feb42be5de43f9852c21ab4a0ef25a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUmVuQ2hpbmc=,size_20,color_FFFFFF,t_70,g_se,x_16" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>使用 Kubeadm 部署 K8S 集群V1.19.0</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span>Recommend</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2021/12/27/使用-Kubeadm-部署-K8S-集群V1-19-0/" title="使用 Kubeadm 部署 K8S 集群V1.19.0"><img class="relatedPosts_cover lozad" data-src="https://img-blog.csdnimg.cn/20feb42be5de43f9852c21ab4a0ef25a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUmVuQ2hpbmc=,size_20,color_FFFFFF,t_70,g_se,x_16"><div class="relatedPosts_title">使用 Kubeadm 部署 K8S 集群V1.19.0</div></a></div></div><div class="clear_both"></div></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2021 By RenChing Doe</div><div class="framework-info"><span>Driven </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://renqingsangbu.github.io/">blog</a>!</div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><i class="fa fa-book" id="readmode" title="Read Mode"> </i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion">繁</a><i class="fa fa-moon-o nightshift" id="nightshift" title="Dark Mode"></i></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script src="/js/nightshift.js"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zindex="-1" data-click="false"></script><script src="/js/activate-power-mode.js"></script><script>POWERMODE.colorful = true; // make power mode colorful
POWERMODE.shake = true; // turn off shake
document.body.addEventListener('input', POWERMODE);
</script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script></body></html>